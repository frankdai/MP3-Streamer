var streamer={};$.getJSON("/getsongs",function(a){function b(a,b){return Math.floor(Math.random()*(b-a))+a}if(a.length){var c=document.getElementById("player"),d=Backbone.Model.extend({play:function(){var a=$("#play .play span");a.removeClass("glyphicon-play").addClass("glyphicon-pause"),c.getAttribute("src")!==this.get("file")&&(c.src=this.get("file")),c.play()},pause:function(){var a=$("#play .play span");a.addClass("glyphicon-play").removeClass("glyphicon-pause"),c.pause()},updateInfo:function(){var a=$("#song-info .artist span"),b=$("#song-info .title span"),c=$("#song-info .album span");a.text(this.get("artist")),b.text(this.get("title")),c.text(this.get("album"))}}),e=Backbone.Collection.extend({model:d}),f=new e(a),g=Backbone.View.extend({tagName:"li",className:"list",template:_.template('<div class="name"><%= title %></div><div class="info"><%= artist %> - <%= album %></div><div class="status"></div>'),render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),h=function(a){var b=$("#songlist"),c=document.createElement("ul");c.className="playlist";a.each(function(b,d){var e=new g({model:b});e.$el.click(function(){j.set({current:d,list:a.models})}),c.appendChild(e.render().el)}),b.html("").append(c)};h(f,"playlist");var i=Backbone.Model.extend({defaults:{current:0,random:!1,playing:!0,list:f.models},initialize:function(){this.play()},prev:function(){var a=this.get("current"),b=a-1;return 0>b&&(b=this.get("list").length-1),b},next:function(){var a=this.get("current"),b=a+1;return b>=this.get("list").length&&(b=0),b},play:function(){var a=this.get("list")[this.get("current")];this.set("playing",!0),a.play(),a.updateInfo()},pause:function(){var a=this.get("list")[this.get("current")];this.set("playing",!1),a.pause()}}),j=new i;j.on("change:current",function(){this.play()},j),j.on("change:playing",function(){var a=this.get("playing");a?this.play():this.pause()},j),j.on("change:list",function(){this.play()},j);var k=function(a){var c;"next"===a&&(c=j.next()),"prev"===a&&(c=j.prev()),j.get("random")&&(c=b(0,j.get("list").length-1)),j.set("current",c)},l=function(a){"random"===a?j.set("random",!0):"one"===a?j.set("singleRepeat",!0):j.set({singleRepeat:!1,random:!1})},m=Backbone.Model.extend(),n=Backbone.View.extend({tagName:"li",className:"list",events:{click:"showAlbum"},showAlbum:function(){var a=this.model.get("model").cid;t.navigate("album/"+a,{trigger:!0})},render:function(){return this.$el.text(this.model.get("name")),this}}),o=function(a){var b=$("#songlist"),c=_.uniq(a.pluck("artist")),d=$('<ul class="artist-list"></ul>');c=_.sortBy(c,function(a){return a}),c.forEach(function(b){var c=new m({name:b,model:a.findWhere({artist:b})}),e=new n({model:c});d.append(e.render().el)}),b.html("").append(d)},p=Backbone.Model.extend(),q=Backbone.View.extend({tagName:"li",className:"list",events:{click:"showSongs"},showSongs:function(){var a=this.model.get("model").cid;t.navigate("album/songs/"+a,{trigger:!0})},template:_.template('<div class="name"><%= artist %></div><div class="info"><%= album %></div>'),render:function(){return this.$el.html(this.template({artist:this.model.get("name"),album:this.model.get("model").get("artist")})),this}}),r=function(a){var b=$("#songlist"),c=_.uniq(a.pluck("album")),d=$('<ul class="album-list"></ul>');c=_.sortBy(c,function(a){return a}),c.forEach(function(b){var c=new p({name:b,model:a.findWhere({album:b})}),e=new q({model:c});d.append(e.render().el)}),b.html("").append(d)},s=Backbone.Router.extend({routes:{library:"library",album:"album",artist:"artist","album/:cid":"renderAlbum","album/songs/:cid":"renderSongs"},library:function(){h(f)},artist:function(){o(f)},album:function(){r(f)},renderAlbum:function(a){var b=f.get(a),c=f.filter(function(a){return a.get("artist")==b.get("artist")}),d=new Backbone.Collection(c);r(d)},renderSongs:function(a){var b=f.get(a),c=f.filter(function(a){return a.get("album")==b.get("album")&&a.get("artist")==b.get("artist")}),d=new Backbone.Collection(c);h(d)}}),t=new s;Backbone.history.start(),streamer.collection=f,streamer.order=l,streamer.control=k,streamer.current=j,streamer.router=t}}),window.addEventListener("load",function(){var a,b,c=document.getElementById("player"),d=$(".progress .progress-bar"),e=$(".play-time .duration"),f=$(".play-time .current"),g=$(".controller .prev"),h=$(".controller .next"),i=$(".controller .play"),j=$(".play-model"),k=0,l=function(a){var b=Math.floor(a/60),c=Math.floor(a%60);return b=b>9?b:"0"+b,c=c>9?c:"0"+c,b+":"+c};c.addEventListener("play",function(){a=window.setInterval(function(){var a=Math.ceil(c.currentTime/c.duration*100)+"%";d.css("width",a),f.text(l(c.currentTime))},1e3)}),c.addEventListener("loadedmetadata",function(){e.text(l(c.duration))}),c.addEventListener("ended",function(){window.clearInterval(a),b?c.loop=!0:streamer.control("next")}),g.on("click",function(){b||streamer.control("prev")}),h.on("click",function(){b||streamer.control("next")}),i.on("click",function(){var a=$(this);a.toggleClass("paused"),a.hasClass("paused")?streamer.current.set("playing",!1):streamer.current.set("playing",!0)}),j.click(function(a){var d=$(this),e=d.find("span").eq(0),f=d.find("span").eq(1);switch(k){case 0:streamer.order("one"),e.attr("class","glyphicon glyphicon-repeat"),c.loop=!0,b=!0,k++;break;case 1:streamer.order("random"),e.attr("class","glyphicon glyphicon-random"),f.text("Shuffle"),c.loop=!1,b=!1,k++;break;case 2:streamer.order(),e.attr("class","glyphicon glyphicon-refresh"),f.text("All"),k=0;break;default:return}});var m=function(){var a=$("#song-info .title"),b=a.find("span"),c=function(){a.css({"text-indent":0,transition:"none"}),a.off("transitionend",c)};b.width()>a.width()&&a.css({"text-indent":0-1.3*(b.width()-a.width())+"px",transition:"all 2s linear"}),a.on("transitionend",c)};window.setInterval(m,4e3);var n=$("nav.nav ul li");n.each(function(a){$(this).click(function(){n.removeClass("active").eq(a).addClass("active")})})});